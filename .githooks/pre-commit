#!/bin/bash

# =============================================================================
# PRE-COMMIT HOOK - Prevent Deployment-Breaking Changes
# =============================================================================
# This hook prevents commits that would break the Laravel application
# by running basic validation checks before allowing the commit.
#
# To enable: 
# - chmod +x .githooks/pre-commit
# - git config core.hooksPath .githooks
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}[PRE-COMMIT]${NC} $1"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_status "Running pre-commit validation checks..."

# Check if this is a Laravel project
if [ ! -f "artisan" ]; then
    print_status "Not a Laravel project, skipping validation"
    exit 0
fi

# Basic Laravel boot test
print_status "Testing Laravel application boot..."
if ! php artisan --version > /dev/null 2>&1; then
    print_error "Laravel application fails to boot"
    print_error "This commit would break the application!"
    exit 1
fi

# Test route compilation
print_status "Testing route compilation..."
php artisan route:clear > /dev/null 2>&1

if ! php artisan route:list > /dev/null 2>&1; then
    print_error "Route compilation failed"
    print_error "Check for missing controllers or broken route definitions"
    exit 1
fi

# Test config compilation
print_status "Testing config compilation..."
php artisan config:clear > /dev/null 2>&1

if ! php artisan config:cache > /dev/null 2>&1; then
    print_error "Configuration caching failed"
    php artisan config:clear > /dev/null 2>&1
    exit 1
fi

php artisan config:clear > /dev/null 2>&1

print_success "All pre-commit checks passed"
print_status "Commit is safe to proceed"

exit 0